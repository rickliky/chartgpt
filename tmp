#!/bin/bash

# Show usage hints
function usage() {
  echo "Usage: $0 <white list> [<exclude list>]"
  echo "  <white list>   Comma-separated list of allowed container names"
  echo "  <exclude list> Optional comma-separated list of excluded container names"
}

# Check if a white list is provided
if [[ -z $1 ]]; then
  echo "ERROR: Please provide a white list as the first argument"
  usage
  exit 1
fi

# Set the white list as an array
IFS=',' read -ra white_list <<< "$1"

# Check if an exclude list is provided
if [[ ! -z $2 ]]; then
  IFS=',' read -ra exclude_list <<< "$2"
else
  exclude_list=()
fi

# Initialize an array to store the names not in the white list
not_in_white_list=()

# Extract the container names
docker ps --format "{{.Names}}" | while read name; do

  # Extract the name before the first underscore
  name=$(echo $name | cut -d'_' -f1)

  # Check if the name is in the exclude list
  if [[ " ${exclude_list[@]} " =~ " $name " ]]; then
    continue
  fi

  # Check if the name is in the white list
  if [[ ! " ${white_list[@]} " =~ " $name " ]]; then
    not_in_white_list+=("$name")
    continue
  fi

  # Print the name
  echo $name

done

# Check if there are any names not in the white list
if [[ ${#not_in_white_list[@]} -gt 0 ]]; then
  echo "ERROR: The following container names are not in the white list:"
  for name in "${not_in_white_list[@]}"; do
    echo "  - $name"
  done
  exit 1
fi
